{% extends "base.html" %}
{% load static %}
{% load custom_tags %}

{% block extra_css %}
<style>

/* --- BUTONLAR --- */
.filter-clear-btn {
    width: 42px;
    height: 42px;
    border-radius: 22px;
    border: 1px solid #e6e9f2;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}
.filter-clear-btn i { font-size: 20px; color: #ff4b4b; }
.filter-clear-btn:hover { background: #fff1f1; border-color: #ffcaca; }

/* --- TABLO --- */
.table-modern {
    width: 100%;
    border-collapse: separate !important;
    border-spacing: 0 10px !important;
}
.table-modern thead th {
    background: #f5f7fb;
    color: #6b7280;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    padding: 14px 18px;
    padding-left: 22px !important;
    border: none !important;
    text-align: left !important;
}
.table-modern tbody tr {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: all .15s ease;
}
.table-modern tbody tr:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}
.table-modern tbody td {
    padding: 16px 18px;
    font-size: 14px;
    border: none !important;
}
.table-modern tbody tr td:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}
.table-modern tbody tr td:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

/* --- HEADER --- */
.modern-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffffee;
    backdrop-filter: blur(12px);
    border-radius: 14px;
    padding: 14px 20px;
    margin: 22px 0;
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
}
.back-btn {
    font-size: 14px;
    background: #f3f4ff;
    padding: 6px 14px;
    border-radius: 8px;
    text-decoration: none;
    color: #3b45d9;
    font-weight: 600;
    border: 1px solid #dfe3ff;
}
.header-center { display: flex; gap: 12px; }
.stat-badge {
    background: linear-gradient(to bottom right, #eef1ff, #dce2ff);
    padding: 8px 16px;
    border-radius: 10px;
    font-weight: 600;
    color: #2c2f48;
}
.search-area { display: flex; gap: 10px; }
.search-box {
    height: 42px;
    width: 240px;
    padding: 0 14px;
    border-radius: 22px;
    border: 1px solid #e6e9f2;
}
.filter-btn {
    width: 42px;
    height: 42px;
    border-radius: 22px;
    border: 1px solid #e6e9f2;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
}
.filter-btn i { font-size: 20px; color: #395bff; }

/* QR */
.qr-box {
    width: 50px;
    height: 50px;
    overflow: hidden;
}
.qr-box img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

/* ACTION BAR */
.action-bar {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 88%;
    max-width: 900px;
    background: #1e2030;
    color: white;
    padding: 14px 22px;
    border-radius: 20px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.28);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 9999999;
    transition: .25s ease;
}
.action-bar.hidden {
    opacity: 0;
    pointer-events: none;
    bottom: 0;
}
.action-buttons { display: flex; gap: 12px; }
.action-btn {
    background: #fff;
    color: #1e2030;
    border: none;
    padding: 8px 16px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    transition: 0.2s;
}
.action-btn:hover { background: #e9e9e9; }
#btnMakePassive, #btnMakeActive { display: none; }
.delete-btn { background: #ff4b4b; color: #fff; }
.delete-btn:hover { background: #d63d3d; }

/* ‚úÖ Highlight */
tr.selected-row {
    background: #f3f6ff !important;
    box-shadow: 0 0 0 2px rgba(74, 99, 255, 0.35);
}

</style>
{% endblock %}


{% block content %}
<div class="container-fluid px-2">

    <!-- HEADER -->
    <div class="modern-header">

        <div class="header-center">
            <div class="stat-badge">üì¶ Toplam: {{ total_count }}</div>
            <div class="stat-badge">‚úÖ Aktif: {{ aktif_count }}</div>
            <div class="stat-badge">üö´ Pasif: {{ pasif_count }}</div>
            <div class="stat-badge">üöö Sevkedilen: {{ sevke_count }}</div>
            <div class="stat-badge">üéØ Filtrelenmi≈ü: {{ filtered_count }}</div>
        </div>

        <div class="search-area">
            <input type="text" id="searchInput" class="search-box" placeholder="Sipari≈ülerde ara‚Ä¶">

            <button class="filter-btn" title="Geli≈ümi≈ü Filtre" type="button">
                <i class="bi bi-sliders"></i>
            </button>

            <button class="filter-clear-btn" id="clearFilters" title="Filtreleri Temizle">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>
    </div>

    {% include "core/_filter_panel.html" %}

    <!-- TABLE -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table-modern" id="orderTable">
            <thead>
                <tr>
                    <th style="width:40px;"></th>
                    <th>Sipari≈ü No</th>
                    <th>M√º≈üteri</th>
                    <th>√úr√ºn Kodu</th>
                    <th>M√º≈üteri Ref</th>
                    <th>Adet</th>
                    <th>Renk</th>
                    <th>Beden</th>
                    <th>A√ßƒ±klama</th>
                    <th>Teslim Tarihi</th>
                    <th>Son Durum</th>
                    <th>Son Durum Tarihi</th>
                    <th>QR Kod</th>
                </tr>
            </thead>

            <tbody>
            {% for order in orders %}
                <tr>
                    <td>
                        <input type="checkbox"
                            class="row-checkbox"
                            data-id="{{ order.id }}"
                            data-is-active="{{ order.is_active|yesno:'1,0' }}"
                            data-printed="{{ order.cikti_alindi|yesno:'1,0' }}"
                            data-toggle-url="{% url 'order_toggle_active' order.pk %}"
                            data-detail-url="{% url 'order_detail' order.pk %}"
                            data-edit-url="{% url 'order_edit' order.pk %}"
                            data-delete-url="{% url 'order_delete' order.pk %}">
                    </td>

                    <td><a href="{% url 'order_detail' order.pk %}">{{ order.siparis_numarasi }}</a></td>
                    <td>{{ order.musteri|default:"-" }}</td>
                    <td>{{ order.urun_kodu }}</td>
                    <td>{{ order.musteri_referans|default:"-" }}</td>
                    <td>{{ order.adet }}</td>
                    <td>{{ order.renk }}</td>
                    <td>{{ order.beden }}</td>
                    <td>{{ order.aciklama|default:"-" }}</td>
                    <td>{{ order.teslim_tarihi|date:"d.m.Y" }}</td>

                    <td style="text-align:center;">
                        {% if order.formatted_status %}
                            {% include "core/_status_badge.html" with status=order.formatted_status %}
                        {% else %}-{% endif %}
                    </td>

                    <td>
                        {% if order.last_status_date %}
                            {{ order.last_status_date|date:"d.m.Y" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>


                    <td>
                        <div class="qr-box">
                            {% if order.qr_code_url %}
                                <img src="{{ order.qr_code_url }}">
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- PAGINATION -->
    {% if orders.has_other_pages %}
    <div class="d-flex justify-content-center my-4">
        <ul class="pagination">

            {% if orders.has_previous %}
            <li class="page-item">
                <a class="page-link"
                   href="?{{ request.GET.urlencode|cut:'page=' }}&page={{ orders.previous_page_number }}">
                    ‚Üê √ñnceki
                </a>
            </li>
            {% endif %}

            {% for num in orders.paginator.page_range %}
                {% if num == orders.number %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > orders.number|add:"-3" and num < orders.number|add:"3" %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?{{ request.GET.urlencode|cut:'page=' }}&page={{ num }}">
                            {{ num }}
                        </a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if orders.has_next %}
            <li class="page-item">
                <a class="page-link"
                   href="?{{ request.GET.urlencode|cut:'page=' }}&page={{ orders.next_page_number }}">
                    Sonraki ‚Üí
                </a>
            </li>
            {% endif %}

        </ul>
    </div>
    {% endif %}

</div>

<!-- ACTION BAR -->
<div id="actionBar" class="action-bar hidden no-print">
    <div class="action-left"><span id="selectedCount">0</span> sipari≈ü se√ßildi</div>
    <div class="action-buttons">
        <button class="action-btn" id="btnLabelPrint">üè∑Ô∏è Etiket Yazdƒ±r</button>
        <button class="action-btn" id="btnPrintOrder" disabled>üñ®Ô∏è Yazdƒ±rƒ±ldƒ± olarak i≈üaretle</button>
        <button class="action-btn" id="btnEdit">‚úèÔ∏è D√ºzenle</button>
        <button class="action-btn" id="btnShare">üîó Payla≈ü</button>
        <button class="action-btn" id="btnMakePassive">üö´ Pasif Et</button>
        <button class="action-btn" id="btnMakeActive">‚úÖ Aktif Et</button>
        <button class="action-btn delete-btn" id="btnDelete">üóëÔ∏è Sil</button>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    // ‚úÖ Select2
    $(".filter-select").select2({
        width: "100%",
        placeholder: "Se√ßiniz",
        allowClear: true,
        closeOnSelect: true
    });

    // ‚úÖ CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ‚úÖ DOM
    const checkboxes = document.querySelectorAll(".row-checkbox");
    const actionBar = document.getElementById("actionBar");
    const selectedCount = document.getElementById("selectedCount");

    const btnMakePassive = document.getElementById("btnMakePassive");
    const btnMakeActive  = document.getElementById("btnMakeActive");

    const btnLabelPrint = document.getElementById("btnLabelPrint");
    const btnPrintOrder = document.getElementById("btnPrintOrder");
    const btnEdit = document.getElementById("btnEdit");
    const btnDelete = document.getElementById("btnDelete");
    const btnShare = document.getElementById("btnShare");

    // ‚úÖ Filtre Panel DOM (include i√ßinden geliyor)
    const filterBtn = document.querySelector(".filter-btn");
    const filterPanel = document.getElementById("filterPanel");
    const filterBackdrop = document.getElementById("filterBackdrop");
    const closeFilterBtn = document.getElementById("closeFilter");

    // ‚úÖ Se√ßili checkbox
    function getSelectedCheckbox() {
        return document.querySelector(".row-checkbox:checked");
    }

    function updateSelection() {
        const selected = document.querySelectorAll(".row-checkbox:checked").length;
        if (selected > 0) {
            actionBar.classList.remove("hidden");
            selectedCount.textContent = selected;
        } else {
            actionBar.classList.add("hidden");
        }
    }

    function syncPrintButton() {
        const cb = getSelectedCheckbox();
        if (!cb) {
            btnPrintOrder.disabled = true;
            btnPrintOrder.innerText = "üñ®Ô∏è Yazdƒ±rƒ±ldƒ± olarak i≈üaretle";
            return;
        }

        const printed = cb.dataset.printed === "1";

        if (printed) {
            btnPrintOrder.disabled = true;
            btnPrintOrder.innerText = "‚úÖ Yazdƒ±rƒ±ldƒ±";
        } else {
            btnPrintOrder.disabled = false;
            btnPrintOrder.innerText = "üñ®Ô∏è Yazdƒ±rƒ±ldƒ± olarak i≈üaretle";
        }
    }

    // ‚úÖ Checkbox tek se√ßim + highlight + aktif/pasif buton
    checkboxes.forEach(cb => {
        cb.addEventListener("click", function (e) {
            e.stopPropagation();

            document.querySelectorAll("#orderTable tbody tr").forEach(row => {
                row.classList.remove("selected-row");
            });

            checkboxes.forEach(other => {
                if (other !== this) other.checked = false;
            });

            if (this.checked) {
                this.closest("tr").classList.add("selected-row");

                const isActive = this.dataset.isActive === "1";
                btnMakePassive.style.display = isActive ? "inline-block" : "none";
                btnMakeActive.style.display  = isActive ? "none" : "inline-block";
            } else {
                btnMakePassive.style.display = "none";
                btnMakeActive.style.display  = "none";
            }

            updateSelection();
            syncPrintButton();
        });
    });

    // ‚úÖ Search
    const searchInput = document.getElementById("searchInput");
    if (searchInput) {
        searchInput.addEventListener("keyup", function () {
            let v = this.value.toLowerCase();
            document.querySelectorAll("#orderTable tbody tr").forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(v) ? "" : "none";
            });
        });
    }

    // ‚úÖ Filtre Panel Open/Close
    function openFilterPanel() {
        if (!filterPanel || !filterBackdrop) return;
        filterPanel.classList.remove("hidden");
        filterBackdrop.classList.remove("hidden");

        setTimeout(() => {
            filterPanel.classList.add("show");
            filterBackdrop.classList.add("show");

            // ‚úÖ SELECT2: panel a√ßƒ±lƒ±nca yeniden init + dropdownParent ayarla
            $("#filterPanel .filter-select").each(function () {
                if ($(this).hasClass("select2-hidden-accessible")) {
                    $(this).select2("destroy");
                }
                $(this).select2({
                    width: "100%",
                    placeholder: "Se√ßiniz",
                    allowClear: true,
                    closeOnSelect: true,
                    dropdownParent: $("#filterPanel")   // ‚úÖ kritik
                });
            });

    }, 10);
}

    function closeFilterPanel() {
        if (!filterPanel || !filterBackdrop) return;
        filterPanel.classList.remove("show");
        filterBackdrop.classList.remove("show");

        setTimeout(() => {
            filterPanel.classList.add("hidden");
            filterBackdrop.classList.add("hidden");
        }, 200);
    }

    if (filterBtn) filterBtn.addEventListener("click", openFilterPanel);
    if (closeFilterBtn) closeFilterBtn.addEventListener("click", closeFilterPanel);
    if (filterBackdrop) filterBackdrop.addEventListener("click", closeFilterPanel);

    // ‚úÖ Filtreleri Temizle
    const clearBtn = document.getElementById("clearFilters");
    if (clearBtn) {
        clearBtn.addEventListener("click", function () {
            window.location.href = window.location.pathname;
        });
    }

    // ‚úÖ Apply Filter
    const applyBtn = document.getElementById("applyFilter");
    if (applyBtn) {
        applyBtn.addEventListener("click", function () {
            let params = [];

            function collect(id, key) {
                let values = $(`#${id}`).val();
                if (values && values.length > 0) {
                    values.forEach(v => params.push(`${key}=${encodeURIComponent(v)}`));
                }
            }

            collect("f_active", "active");
            collect("f_siparis_no", "siparis_no");
            collect("f_musteri", "musteri");
            collect("f_urun", "urun_kodu");
            collect("f_renk", "renk");
            collect("f_beden", "beden");
            collect("f_status", "status");

            window.location.href = "?" + params.join("&");
        });
    }

    // ‚úÖ Restore Filter from URL
    const urlParams = new URLSearchParams(window.location.search);

    function restoreSelect(id, key) {
        if (!urlParams.has(key)) return;
        const values = urlParams.getAll(key);
        if (values.length) {
            $(`#${id}`).val(values).trigger("change");
        }
    }

    restoreSelect("f_active", "active");
    restoreSelect("f_siparis_no", "siparis_no");
    restoreSelect("f_musteri", "musteri");
    restoreSelect("f_urun", "urun_kodu");
    restoreSelect("f_renk", "renk");
    restoreSelect("f_beden", "beden");
    restoreSelect("f_status", "status");

    // ‚úÖ Toggle Active
    async function toggleActive() {
        const cb = getSelectedCheckbox();
        if (!cb) return alert("Sipari≈ü se√ßilmedi");

        const toggleUrl = cb.dataset.toggleUrl;
        if (!toggleUrl) return alert("Toggle URL yok");

        try {
            const res = await fetch(toggleUrl, {
                method: "POST",
                headers: { "X-CSRFToken": getCookie("csrftoken") }
            });

            const data = await res.json();
            if (data.success) window.location.reload();
            else alert("ƒ∞≈ülem ba≈üarƒ±sƒ±z ‚ùå");

        } catch (e) {
            alert("Hata olu≈ütu ‚ùå");
        }
    }

    // ‚úÖ Aktif/Pasif
    btnMakePassive.addEventListener("click", () => {
        if (!confirm("Sipari≈ü pasif yapƒ±lsƒ±n mƒ±?")) return;
        toggleActive();
    });

    btnMakeActive.addEventListener("click", () => {
        if (!confirm("Sipari≈ü aktif yapƒ±lsƒ±n mƒ±?")) return;
        toggleActive();
    });

    // ‚úÖ Print
    btnLabelPrint.addEventListener("click", () => {
        const cb = getSelectedCheckbox();
        if (!cb) return alert("Sipari≈ü se√ßilmedi");
        window.open(`/orders/label/print/?ids=${cb.dataset.id}`, "_blank");
    });

    btnPrintOrder.addEventListener("click", async () => {
        const cb = getSelectedCheckbox();
        if (!cb) return alert("Sipari≈ü se√ßilmedi");

        // Zaten yazdƒ±rƒ±ldƒ±ysa i≈ülem yapma
        if (cb.dataset.printed === "1") {
            return window.location.href = cb.dataset.detailUrl;
        }

        const actionUrl = `/order/${cb.dataset.id}/cikti-alindi/`;

        try {
            const res = await fetch(actionUrl, {
                method: "POST",
                headers: { "X-CSRFToken": getCookie("csrftoken") }
            });

            if (!res.ok) {
                alert("Yazdƒ±rƒ±ldƒ± i≈üaretlenemedi ‚ùå");
                return;
            }

            // UI: o satƒ±rƒ± hemen printed yap
            cb.dataset.printed = "1";
            syncPrintButton();

            // Detail'e git
            window.location.href = cb.dataset.detailUrl;

        } catch (e) {
            alert("Hata olu≈ütu ‚ùå");
        }
    });


    // ‚úÖ Edit
    btnEdit.addEventListener("click", () => {
        const cb = getSelectedCheckbox();
        if (!cb) return alert("Sipari≈ü se√ßilmedi");
        window.location.href = cb.dataset.editUrl;
    });

    // ‚úÖ Delete
    btnDelete.addEventListener("click", async () => {
        const cb = getSelectedCheckbox();
        if (!cb) return alert("Sipari≈ü se√ßilmedi");

        if (!confirm("Bu sipari≈ü silinsin mi?")) return;

        try {
            const res = await fetch(cb.dataset.deleteUrl, {
                method: "POST",
                headers: { "X-CSRFToken": getCookie("csrftoken") }
            });

            if (res.ok) window.location.reload();
            else alert("Silinemedi ‚ùå");

        } catch {
            alert("Hata olu≈ütu ‚ùå");
        }
    });

    // ‚úÖ Share
    btnShare.addEventListener("click", async () => {
        const cb = getSelectedCheckbox();
        if (!cb) return alert("Sipari≈ü se√ßilmedi");

        const link = window.location.origin + cb.dataset.detailUrl;
        try {
            await navigator.clipboard.writeText(link);
            alert("Link kopyalandƒ± ‚úÖ");
        } catch {
            prompt("Linki kopyalayƒ±n:", link);
        }
    });

    syncPrintButton();
    
});
</script>
{% endblock %}
