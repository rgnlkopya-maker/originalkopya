{% extends "base.html" %}
{% load static %}
{% load custom_tags %}

{% block extra_css %}
<style>

.filter-clear-btn {
    width: 42px;
    height: 42px;
    border-radius: 22px;
    border: 1px solid #e6e9f2;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.filter-clear-btn i {
    font-size: 20px;
    color: #ff4b4b;
}

.filter-clear-btn:hover {
    background: #fff1f1;
    border-color: #ffcaca;
}

/* --- MODERN SAA S / FIGMA TARZI TABLO --- */

.table-modern {
    width: 100%;
    border-collapse: separate !important;
    border-spacing: 0 10px !important; /* Satƒ±rlar arasƒ±nda bo≈üluk */
}

.table-modern thead th {
    background: #f5f7fb;
    color: #6b7280;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    padding: 14px 18px;
    padding-left: 22px !important; 
    border: none !important;
    text-align: left !important;
}

.table-modern tbody tr {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: all .15s ease;
}

.table-modern tbody tr:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

.table-modern tbody td {
    padding: 16px 18px;
    font-size: 14px;
    border: none !important;
}

/* Yuvarlatƒ±lmƒ±≈ü kart efekti */
.table-modern tbody tr td:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}
.table-modern tbody tr td:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

/* Modern Badge (durum renkleri) */
.status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    display: inline-block;
    white-space: nowrap;
}

.status-green { background: #d1fae5; color: #065f46; }
.status-blue  { background: #dbeafe; color: #1e40af; }
.status-yellow{ background: #fef3c7; color: #b45309; }
.status-gray  { background: #e5e7eb; color: #374151; }


.status-ok { background: #d1fae5; color: #065f46; }
.status-warn { background: #fef3c7; color: #b45309; }
.status-info { background: #dbeafe; color: #1e40af; }

/* Yazdƒ±r butonu modern */
.btn-modern {
    padding: 6px 14px;
    background: #eef1ff;
    border-radius: 8px;
    border: none;
    color: #3949ff;
    transition: .15s;
}
.btn-modern:hover {
    background: #dce2ff;
    transform: translateY(-1px);
}


.modern-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffffee;
    backdrop-filter: blur(12px);
    border-radius: 14px;
    padding: 14px 20px;
    margin: 22px 0;
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
}

.back-btn {
    font-size: 14px;
    background: #f3f4ff;
    padding: 6px 14px;
    border-radius: 8px;
    text-decoration: none;
    color: #3b45d9;
    font-weight: 600;
    border: 1px solid #dfe3ff;
}

.header-center { display: flex; gap: 12px; }

.stat-badge {
    background: linear-gradient(to bottom right, #eef1ff, #dce2ff);
    padding: 8px 16px;
    border-radius: 10px;
    font-weight: 600;
    color: #2c2f48;
}

.search-area { display: flex; gap: 10px; }

.search-box {
    height: 42px;
    width: 240px;
    padding: 0 14px;
    border-radius: 22px;
    border: 1px solid #e6e9f2;
}

.filter-btn {
    width: 42px;
    height: 42px;
    border-radius: 22px;
    border: 1px solid #e6e9f2;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
}
.filter-btn i { font-size: 20px; color: #395bff; }

/* QR Fix */
.qr-box {
    width: 50px;
    height: 50px;
    overflow: hidden;
}
.qr-box img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

/* === SELECTƒ∞ON BAR MODERN TASARIM === */

.action-bar {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 88%;
    max-width: 900px;
    background: #1e2030;
    color: white;
    padding: 14px 22px;
    border-radius: 20px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.28);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 9999999;
    pointer-events: auto;
    opacity: 1;
    transition: .25s ease;
}

.action-bar.hidden {
    opacity: 0;
    pointer-events: none;
    bottom: 0;
}

.action-left {
    font-size: 15px;
    font-weight: 500;
}

.action-buttons {
    display: flex;
    gap: 12px;
}

.action-btn {
    background: #fff;
    color: #1e2030;
    border: none;
    padding: 8px 16px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    transition: 0.2s;
}

.action-btn:hover {
    background: #e9e9e9;
}

.delete-btn {
    background: #ff4b4b;
    color: #fff;
}

.delete-btn:hover {
    background: #d63d3d;
}

/* === BACKDROP TIKLAMA BLOKE ETMESƒ∞N === */
#filterBackdrop.hidden{
  pointer-events: none !important;
  opacity: 0 !important;
  visibility: hidden !important;
}

#filterBackdrop.show{
  pointer-events: auto !important;
  opacity: 1 !important;
  visibility: visible !important;
}

/* Action bar her durumda tƒ±klanabilir olsun */
.action-bar{
  pointer-events: auto !important;
}

</style>
{% endblock %}



{% block content %}
<div class="container-fluid px-2">

    <!-- HEADER -->
    <div class="modern-header">

        <a href="/management/" class="back-btn">‚Üê Geri D√∂n</a>

        <div class="header-center">
            <div class="stat-badge">üì¶ Toplam: {{ total_count }}</div>
            <div class="stat-badge">üéØ Filtrelenmi≈ü: {{ filtered_count }}</div>
        </div>

        <div class="search-area">
            <input type="text" id="searchInput" class="search-box" placeholder="Sipari≈ülerde ara‚Ä¶">

            <button class="filter-btn" title="Geli≈ümi≈ü Filtre">
                <i class="bi bi-sliders"></i>
            </button>

            <button class="filter-clear-btn" id="clearFilters" title="Filtreleri Temizle">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>


    </div>

    {% include "core/_filter_panel.html" %}

    <!-- TABLE -->
    <div class="table-responsive shadow-sm rounded">

        <table class="table-modern" id="orderTable">

    <thead>
        <tr>
            <th style="width:40px;"><input type="checkbox" id="selectAll"></th>
            <th>Sipari≈ü No</th>
            <th>M√º≈üteri</th>
            <th>√úr√ºn Kodu</th>
            <th>M√º≈üteri Ref</th>
            <th>Adet</th>
            <th>Renk</th>
            <th>Beden</th>
            <th>A√ßƒ±klama</th>
            <th>Teslim Tarihi</th>
            <th>Son Durum</th>
            <th>QR Kod</th>
        </tr>
    </thead>


            <tbody>
            {% for order in orders %}
                <tr>
                    <td><input type="checkbox"
         class="row-checkbox"
         data-id="{{ order.id }}"
         data-qr="{{ order.qr_code_url|default_if_none:'' }}"
         data-siparis-no="{{ order.siparis_numarasi|escape }}"
         data-siparis-tipi="{{ order.siparis_tipi|default_if_none:''|escape }}"
         data-musteri="{{ order.musteri|default_if_none:''|escape }}"
         data-urun-kodu="{{ order.urun_kodu|escape }}"
         data-renk="{{ order.renk|escape }}"
         data-beden="{{ order.beden|escape }}"
         data-musteri-ref="{{ order.musteri_referans|default_if_none:''|escape }}"
         data-aciklama="{{ order.aciklama|default_if_none:''|escape }}"
  >
</td>
                    <td>
    <a href="{% url 'order_detail' order.pk %}" class="order-link">
        {{ order.siparis_numarasi }}
    </a>
</td>
                    <td>{{ order.musteri|default:"-" }}</td>
                    <td>{{ order.urun_kodu }}</td>
                    <td>{{ order.musteri_referans|default:"-" }}</td>
                    <td>{{ order.adet }}</td>
                    <td>{{ order.renk }}</td>
                    <td>{{ order.beden }}</td>
                    <td>{{ order.aciklama|default:"-" }}</td>
                    <td>{{ order.teslim_tarihi|date:"d.m.Y" }}</td>

                    <td style="text-align:center;">
    {% if order.formatted_status %}
        {% include "core/_status_badge.html" with status=order.formatted_status %}
    {% else %}
        -
    {% endif %}
</td>

                    <td>
                        <div class="qr-box">
                            {% if order.qr_code_url %}
                                <img src="{{ order.qr_code_url }}">
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>

        </table>

    </div>

    <!-- ========================= -->
<!-- PAGINATION (SAYFALAMA) -->
<!-- ========================= -->
{% if orders.has_other_pages %}
<div class="d-flex justify-content-center my-4">
    <ul class="pagination">

        {% if orders.has_previous %}
        <li class="page-item">
            <a class="page-link"
               href="?{{ request.GET.urlencode|cut:'page=' }}&page={{ orders.previous_page_number }}">
                ‚Üê √ñnceki
            </a>
        </li>
        {% endif %}

        {% for num in orders.paginator.page_range %}
            {% if num == orders.number %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% elif num > orders.number|add:"-3" and num < orders.number|add:"3" %}
                <li class="page-item">
                    <a class="page-link"
                       href="?{{ request.GET.urlencode|cut:'page=' }}&page={{ num }}">
                        {{ num }}
                    </a>
                </li>
            {% endif %}
        {% endfor %}

        {% if orders.has_next %}
        <li class="page-item">
            <a class="page-link"
               href="?{{ request.GET.urlencode|cut:'page=' }}&page={{ orders.next_page_number }}">
                Sonraki ‚Üí
            </a>
        </li>
        {% endif %}

    </ul>
</div>
{% endif %}

</div>

<div id="actionBar" class="action-bar hidden no-print">
    <div class="action-left">
        <span id="selectedCount">0</span> sipari≈ü se√ßildi
    </div>

    <div class="action-buttons">
        <div class="action-buttons">

    <button class="action-btn" id="btnLabelPrint">
        üè∑Ô∏è Etiket Yazdƒ±r
    </button>

    <button class="action-btn" id="btnPrintOrder">
        üñ®Ô∏è Sipari≈ü Yazdƒ±r
    </button>

    <button class="action-btn" id="btnEdit">
        ‚úèÔ∏è D√ºzenle
    </button>

    <button class="action-btn">
        üîó Payla≈ü
    </button>

    <button class="action-btn delete-btn" id="btnDelete">
        üóëÔ∏è Sil
    </button>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    // ===============================
    // Select2 Ayarlarƒ±
    // ===============================
    $(".filter-select").select2({
        width: "100%",
        placeholder: "Se√ßiniz",
        allowClear: true,
        closeOnSelect: true
    });

    // =============================
    // CSRF TOKEN
    // =============================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // =============================
    // SE√áƒ∞M BAR
    // =============================
    const checkboxes = document.querySelectorAll(".row-checkbox");
    const selectAll = document.getElementById("selectAll");
    const actionBar = document.getElementById("actionBar");
    const selectedCount = document.getElementById("selectedCount");

    function updateSelection() {
        const selected = document.querySelectorAll(".row-checkbox:checked").length;
        if (selected > 0) {
            actionBar.classList.remove("hidden");
            selectedCount.textContent = selected;
        } else {
            actionBar.classList.add("hidden");
        }
    }

    checkboxes.forEach(cb => cb.addEventListener("change", updateSelection));

    if (selectAll) {
        selectAll.addEventListener("change", function () {
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelection();
        });
    }

    // =============================
    // ARAMA
    // =============================
    const searchInput = document.getElementById("searchInput");
    if (searchInput) {
        searchInput.addEventListener("keyup", function () {
            let v = this.value.toLowerCase();
            document.querySelectorAll("#orderTable tbody tr").forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(v) ? "" : "none";
            });
        });
    }

    // =============================
    // Fƒ∞LTRE PANEL
    // =============================
    const filterBtn = document.querySelector(".filter-btn");
    const filterPanel = document.getElementById("filterPanel");
    const filterBackdrop = document.getElementById("filterBackdrop");
    const closeFilterBtn = document.getElementById("closeFilter");

    function openFilterPanel() {
        filterPanel.classList.remove("hidden");
        filterBackdrop.classList.remove("hidden");
        setTimeout(() => {
            filterPanel.classList.add("show");
            filterBackdrop.classList.add("show");
        }, 10);
    }

    function closeFilterPanel() {
        filterPanel.classList.remove("show");
        filterBackdrop.classList.remove("show");
        setTimeout(() => {
            filterPanel.classList.add("hidden");
            filterBackdrop.classList.add("hidden");
        }, 200);
    }

    if (filterBtn) filterBtn.addEventListener("click", openFilterPanel);
    if (closeFilterBtn) closeFilterBtn.addEventListener("click", closeFilterPanel);
    if (filterBackdrop) filterBackdrop.addEventListener("click", closeFilterPanel);

    // =============================
    // Fƒ∞LTRELERƒ∞ TEMƒ∞ZLE
    // =============================
    document.addEventListener("click", function (e) {
    if (!e.target.closest("#clearFilters")) return;

    // T√úM Fƒ∞LTRELERƒ∞ GER√áEKTEN TEMƒ∞ZLE
    window.location.href = window.location.pathname;
});

    // =============================
// Fƒ∞LTRELERƒ∞ UYGULA
// =============================
const applyBtn = document.getElementById("applyFilter");
if (applyBtn) {
    applyBtn.addEventListener("click", function () {
        let params = [];

        function collect(id, key) {
            let values = $(`#${id}`).val();
            if (values && values.length > 0) {
                values.forEach(v => params.push(`${key}=${encodeURIComponent(v)}`));
            }
        }

        collect("f_siparis_no", "siparis_no");
        collect("f_musteri", "musteri");
        collect("f_urun", "urun_kodu");
        collect("f_renk", "renk");
        collect("f_beden", "beden");
        collect("f_status", "status");

        window.location.href = "?" + params.join("&");
    });
}

    // =============================
    // URL ‚Üí SELECT2 GERƒ∞ Y√úKLEME
    // =============================
    const urlParams = new URLSearchParams(window.location.search);

    function restoreSelect(id, key) {
        if (!urlParams.has(key)) return;
        const values = urlParams.getAll(key);
        if (values.length) {
            $(`#${id}`).val(values).trigger("change");
        }
    }

    restoreSelect("f_siparis_no", "siparis_no");
    restoreSelect("f_musteri", "musteri");
    restoreSelect("f_urun", "urun_kodu");
    restoreSelect("f_renk", "renk");
    restoreSelect("f_beden", "beden");
    restoreSelect("f_status", "status");

        // =============================
    // ACTION BAR BUTONLARI
    // =============================

    const btnLabelPrint = document.getElementById("btnLabelPrint");
    const btnPrintOrder = document.getElementById("btnPrintOrder");
    const btnEdit = document.getElementById("btnEdit");
    const btnDelete = document.getElementById("btnDelete");

    function getSelectedOrders() {
        return Array.from(document.querySelectorAll(".row-checkbox:checked"))
            .map(cb => cb.dataset.id);
    }

    if (btnLabelPrint) {
        btnLabelPrint.addEventListener("click", function () {
            const ids = getSelectedOrders();
            if (!ids.length) {
                alert("Sipari≈ü se√ßilmedi");
                return;
            }
            alert("Etiket yazdƒ±rƒ±lacak sipari≈ü ID‚Äôleri: " + ids.join(", "));
        });
    }

    if (btnPrintOrder) {
        btnPrintOrder.addEventListener("click", function () {
            const ids = getSelectedOrders();
            if (!ids.length) {
                alert("Sipari≈ü se√ßilmedi");
                return;
            }

            window.open(
                "/orders/print/?ids=" + ids.join("&ids="),
                "_blank"
            );
        });
    }


    if (btnEdit) {
        btnEdit.addEventListener("click", function () {
            const ids = getSelectedOrders();
            if (ids.length !== 1) {
                alert("D√ºzenlemek i√ßin 1 sipari≈ü se√ßmelisin");
                return;
            }
            window.location.href = `/orders/${ids[0]}/edit/`;
        });
    }

    if (btnDelete) {
        btnDelete.addEventListener("click", function () {
            const ids = getSelectedOrders();
            if (!ids.length) {
                alert("Sipari≈ü se√ßilmedi");
                return;
            }

            if (!confirm(ids.length + " sipari≈ü silinsin mi?")) return;

            alert("Silinecek sipari≈ü ID‚Äôleri: " + ids.join(", "));
            // Buraya AJAX delete gelecek
        });
    }



});
</script>
{% endblock %}

