{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
body { background: #f5f7fb; }

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffffee;
    backdrop-filter: blur(12px);
    border-radius: 14px;
    padding: 14px 20px;
    margin: 22px 0 18px 0;
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
}

.detail-header-left { display: flex; gap: 10px; align-items: center; }

.detail-back-btn {
    font-size: 14px;
    background: #f3f4ff;
    padding: 6px 14px;
    border-radius: 8px;
    text-decoration: none;
    color: #3b45d9;
    font-weight: 600;
    border: 1px solid #dfe3ff;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.detail-back-btn:hover { background: #e5e7ff; }

.detail-header-title { font-size: 20px; font-weight: 700; color: #111827; }

.detail-header-actions { display: flex; gap: 8px; align-items: center; }
.detail-header-actions .btn { border-radius: 999px; font-size: 13px; padding: 6px 14px; }

.detail-card { border-radius: 16px; box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08); }

.label { font-weight: 600; }
.stage-buttons form { display: inline-block; margin-right: 5px; margin-bottom: 5px; }

.qr-print-block { display: flex; align-items: center; gap: 15px; font-size: 14px; line-height: 1.3; }
.qr-print-block img, .qr-img { max-height: 140px; width: auto; }

@media print {
    html, body { margin: 0 !important; padding: 0 !important; width: 100% !important; height: auto !important; }
    .container, .card { max-width: 100% !important; width: 100% !important; box-shadow: none !important; border: none !important; margin: 0 !important; padding: 5mm !important; }
    .no-print, .btn-warning, .extra-images-section, .extra-images-section + form { display: none !important; }
    .qr-print-block { display: flex !important; align-items: center !important; gap: 20px !important; font-size: 18pt !important; line-height: 1.4 !important; }
    .qr-print-block img, .qr-img { max-height: 260px !important; width: auto !important; }
    .qr-print-block .qr-text { font-size: 18pt !important; line-height: 1.4 !important; font-weight: 600 !important; }
    .qr-print-block .qr-text div { font-size: inherit !important; line-height: inherit !important; }
}

.extra-images-section { position: relative; z-index: 999 !important; }
.extra-images-section img {
    position: relative;
    z-index: 1001 !important;
    pointer-events: auto !important;
    cursor: pointer !important;
    border-radius: 8px;
    transition: transform 0.2s ease;
}
.extra-images-section img:hover { transform: scale(1.03); filter: brightness(1.05); }
.extra-images-section form { position: absolute !important; top: 2px !important; right: 2px !important; z-index: 2000 !important; }

#lightboxOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
#lightboxOverlay img {
  display: block;
  max-width: none;
  max-height: none;
  width: 60vw;
  height: auto;
  border-radius: 10px;
  box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
  transition: transform 0.25s ease-in-out;
  transform: scale(1.05);
}
#lightboxOverlay img:hover { transform: scale(1.15); }

@media (max-width: 768px) {
  #lightboxOverlay img { width: 90vw; transform: none; }
}

#lightboxPrev, #lightboxNext {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 2rem;
  color: white;
  background: rgba(0,0,0,0.4);
  border: none;
  padding: 8px 14px;
  border-radius: 50%;
  cursor: pointer;
  user-select: none;
}
#lightboxPrev { left: 30px; }
#lightboxNext { right: 30px; }
#lightboxPrev:hover, #lightboxNext:hover { background: rgba(255,255,255,0.3); }
@media print { #lightboxOverlay { display: none !important; } }
</style>
{% endblock %}



{% block content %}
<div class="container-fluid px-2 py-3">

    <div class="detail-header no-print">
        <div class="detail-header-left">
            <a href="{% url 'order_list' %}" class="detail-back-btn">üè† <span>Anasayfa</span></a>
            <a href="{{ back_url }}" class="detail-back-btn">‚¨Ö <span>Geri</span></a>
        </div>

        <div class="detail-header-title">üì¶ Sipari≈ü Detayƒ±</div>

        <div class="detail-header-actions">
            {% if is_manager %}
                <a href="{% url 'order_edit' order.id %}" class="btn btn-warning btn-sm">‚úèÔ∏è D√ºzenle</a>
                <button type="button" onclick="window.print()" class="btn btn-outline-primary btn-sm">üñ®Ô∏è Yazdƒ±r</button>

                <form action="{% url 'order_delete' order.id %}" method="POST" class="d-inline-block"
                      onsubmit="return confirm('Bu sipari≈üi silmek istediƒüine emin misin?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Sil</button>
                </form>
            {% endif %}
        </div>
    </div>


    <div class="card shadow-lg mx-auto p-4 detail-card" style="max-width: 900px;">

        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-muted small">
                <span class="label">Sipari≈ü No:</span> {{ order.siparis_numarasi }}
            </div>
        </div>

        <hr>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Sipari≈ü Tipi:</span> {{ order.siparis_tipi }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <span class="label">M√º≈üteri:</span>
                {% if order.musteri %}
                    {{ order.musteri }}
                {% elif order.siparis_tipi == 'STOK' %}
                    <em class="text-secondary">Stoƒüa √úretim</em>
                {% else %}
                    <span class="text-muted">‚Äî</span>
                {% endif %}
            </div>
            <div class="col-md-6"><span class="label">√úr√ºn Kodu:</span> {{ order.urun_kodu }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-12">
                <span class="label">M√º≈üteri Sipari≈ü Referansƒ±:</span>
                {{ order.musteri_referans|default:"‚Äî" }}
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Renk:</span> {{ order.renk }}</div>
            <div class="col-md-6"><span class="label">Beden:</span> {{ order.beden }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Adet:</span> {{ order.adet }}</div>
            <div class="col-md-6"><span class="label">Sipari≈ü Tarihi:</span> {{ order.siparis_tarihi|date:"d.m.Y" }}</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6"><span class="label">Teslim Tarihi:</span> {{ order.teslim_tarihi|date:"d.m.Y" }}</div>
            <div class="col-md-6"><span class="label">A√ßƒ±klama:</span> {{ order.aciklama }}</div>
        </div>


        <h5 class="fw-bold mt-4">üì∏ Ek Sipari≈ü G√∂rselleri</h5>
        <div class="d-flex flex-wrap justify-content-center mb-3 extra-images-section">
            {% for img in order.extra_images.all %}
            <div class="position-relative d-inline-block m-2">
                {% if img.image_url %}
                    <img src="{{ img.image_url }}"
                         alt="Ek G√∂rsel"
                         class="img-thumbnail shadow-sm preview-img"
                         style="max-height:180px; border-radius:8px; cursor: zoom-in;">
                {% else %}
                    <div class="text-center border rounded p-2 bg-light text-muted" style="width:180px; height:120px;">
                        ‚ö†Ô∏è G√∂rsel baƒülantƒ±sƒ± yok
                    </div>
                {% endif %}

                {% if is_manager %}
                <form action="{% url 'delete_order_image' img.id %}" method="POST"
                      class="position-absolute top-0 end-0 m-1 no-print"
                      onsubmit="return confirm('Bu g√∂rseli silmek istediƒüine emin misin?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger py-0 px-1"
                            style="font-size: 0.7rem; line-height: 1; opacity: 0.8;">
                        ‚úï
                    </button>
                </form>
                {% endif %}
            </div>
            {% empty %}
            <p class="text-muted">Hen√ºz ek g√∂rsel yok.</p>
            {% endfor %}
        </div>

        {% if is_manager %}
        <form action="{% url 'order_add_image' order.pk %}" method="POST"
              enctype="multipart/form-data" class="no-print mt-3">
            {% csrf_token %}
            <input type="file" name="images" accept="image/*" multiple required>
            <button type="submit" class="btn btn-outline-secondary btn-sm">üì§ √áoklu G√∂rsel Y√ºkle</button>
        </form>
        {% endif %}


        <div class="card border-danger mt-4" style="max-width: 650px; margin: 0 auto;">
            <div class="card-header bg-danger text-white fw-bold">‚ö†Ô∏è Sipari≈ü D√ºzenleme Kayƒ±tlarƒ±</div>
            <div class="card-body">
                {% if update_events %}
                    <ul class="list-group">
                        {% for ev in update_events %}
                            <li class="list-group-item">
                                <strong>{{ ev.stage|title }}</strong> alanƒ± deƒüi≈üti:
                                <br>
                                <small class="text-muted">√ñnce:</small>
                                <span class="text-decoration-line-through text-muted">{{ ev.old_value|default:"‚Äî" }}</span>
                                <br>
                                <small class="text-muted">Sonra:</small>
                                <span class="fw-bold text-danger">{{ ev.new_value }}</span>
                                <br>
                                <small class="text-muted">{{ ev.timestamp|date:"d.m.Y H:i" }} ‚Äî {{ ev.user }}</small>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-muted fst-italic">Bu sipari≈üte hen√ºz d√ºzenleme yapƒ±lmamƒ±≈ü.</div>
                {% endif %}
            </div>
        </div>


        <div class="mt-4 no-print" id="uretim-paneli">
            {% include "core/_uretim_paneli.html" with order=order events=events %}
        </div>


        <hr class="mt-4">
        <h5 class="mt-3">üìä √úretim Adet Kaydƒ±</h5>
        <div class="d-flex gap-4 align-items-center no-print">
            <div>
                <input type="checkbox" id="adet_kesim" onchange="adetKaydet(this, 'adet_kesim')">
                <label for="adet_kesim">Kesim Tamamlandƒ±</label>
            </div>
            <div>
                <input type="checkbox" id="adet_dikim" onchange="adetKaydet(this, 'adet_dikim')">
                <label for="adet_dikim">Dikim Tamamlandƒ±</label>
            </div>
            <div>
                <input type="checkbox" id="adet_susleme" onchange="adetKaydet(this, 'adet_susleme')">
                <label for="adet_susleme">S√ºsleme Tamamlandƒ±</label>
            </div>
        </div>


        {% if is_manager %}
        <div class="cost-section no-print">
            <hr>
            <h5 class="mt-4">üí∞ Maliyet & K√¢r Bilgileri</h5>

            <table class="table table-sm table-bordered bg-white">

                <tr>
                    <th>Satƒ±≈ü Fiyatƒ±</th>
                    <td>
                        {% if order.satis_fiyati is not None %}
                            {{ order.satis_fiyati|floatformat:2 }} {{ order.para_birimi|default:"‚Ç∫" }}
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                </tr>

                <tr>
                    <th>Etkin Maliyet</th>
                    <td>
                        {% if order.efektif_maliyet is not None %}
                            {{ order.efektif_maliyet|floatformat:2 }} {{ order.maliyet_para_birimi|default:"‚Ç∫" }}
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                </tr>

                <tr>
                    <th>Ekstra Maliyet</th>
                    <td>
                        {% if order.ekstra_maliyet is not None %}
                            {{ order.ekstra_maliyet|floatformat:2 }} {{ order.maliyet_para_birimi|default:"‚Ç∫" }}
                        {% else %}
                            0,00 {{ order.maliyet_para_birimi|default:"‚Ç∫" }}
                        {% endif %}
                    </td>
                </tr>

                <tr>
                    <th>Toplam Maliyet</th>
                    <td>
                        {% if order.toplam_maliyet is not None %}
                            {{ order.toplam_maliyet|floatformat:2 }} {{ order.maliyet_para_birimi|default:"‚Ç∫" }}
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                </tr>

                <tr>
                    <th><b>K√¢r</b></th>
                    <td>
                        {% if order.kar_backend is not None %}
                            <b>{{ order.kar_backend|floatformat:2 }} {{ order.para_birimi|default:"‚Ç∫" }}</b>
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                </tr>

            </table>
        </div>
        {% endif %}

    </div>
</div>


<button id="printImageBtn" class="btn btn-light btn-sm no-print" style="
  position: fixed;
  bottom: 30px;
  right: 50%;
  transform: translateX(50%);
  z-index: 99999;
  box-shadow: 0 3px 10px rgba(0,0,0,0.3);
  border-radius: 6px;
  font-weight: 500;
  display: none;
">
  üñ®Ô∏è Yazdƒ±r
</button>

<div id="lightboxOverlay">
  <button id="lightboxPrev">‚ü®</button>
  <img id="lightboxImage" src="">
  <button id="lightboxNext">‚ü©</button>
</div>

{% endblock %}



{% block extra_js %}

<script>
function adetKaydet(checkbox, stage) {
    if (!checkbox.checked) return;
    htmx.ajax('POST', "{% url 'update_stage' order.id %}", {
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        target: '#uretim-paneli',
        swap: 'outerHTML',
        values: {
            stage: stage,
            value: 'done',
            is_production_count: '1'
        }
    });
}

document.addEventListener('click', function(e) {
  const overlay = document.getElementById('lightboxOverlay');
  const printBtn = document.getElementById('printImageBtn');

  if (overlay && overlay.style.display === 'flex') {
    printBtn.style.display = 'block';
  } else {
    printBtn.style.display = 'none';
  }

  if (e.target === overlay) {
    printBtn.style.display = 'none';
  }
});

document.getElementById('printImageBtn').addEventListener('click', function() {
  const img = document.querySelector('#lightboxOverlay img');
  if (!img) return;

  const w = window.open('', '_blank');
  w.document.write(`
    <html>
      <head><title>G√∂rsel Yazdƒ±r</title></head>
      <body style="margin:0; display:flex; justify-content:center; align-items:center; height:100vh;">
        <img src="${img.src}" style="max-width:100%; max-height:100%;">
        <script>window.print();<\/script>
      </body>
    </html>
  `);
  w.document.close();
});

document.addEventListener('DOMContentLoaded', () => {
  const imgs = Array.from(document.querySelectorAll('.preview-img'));
  const overlay = document.getElementById('lightboxOverlay');
  const overlayImg = document.getElementById('lightboxImage');
  const prevBtn = document.getElementById('lightboxPrev');
  const nextBtn = document.getElementById('lightboxNext');
  let currentIndex = -1;

  function showImage(index) {
    if (index < 0 || index >= imgs.length) return;
    overlayImg.src = imgs[index].src;
    overlay.style.display = 'flex';
    currentIndex = index;
  }

  imgs.forEach((img, i) => {
    img.addEventListener('click', () => showImage(i));
  });

  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.style.display = 'none';
  });

  document.addEventListener('keydown', e => {
    if (overlay.style.display === 'flex') {
      if (e.key === 'Escape') overlay.style.display = 'none';
      else if (e.key === 'ArrowRight') showImage((currentIndex + 1) % imgs.length);
      else if (e.key === 'ArrowLeft') showImage((currentIndex - 1 + imgs.length) % imgs.length);
    }
  });

  prevBtn.addEventListener('click', () => showImage((currentIndex - 1 + imgs.length) % imgs.length));
  nextBtn.addEventListener('click', () => showImage((currentIndex + 1) % imgs.length));
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>
{% endblock %}
