{# core/_uretim_paneli.html #}

<style>
    .production-wrapper {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.3fr);
        gap: 24px;
        margin-top: 24px;
    }

    @media (max-width: 992px) {
        .production-wrapper {
            grid-template-columns: 1fr;
        }
    }

    /* ğŸ¯ Timeline alanÄ± */
    .timeline-card {
        background: #ffffff;
        border-radius: 14px;
        padding: 16px 18px;
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);
        border: 1px solid #e5e7eb;
    }

    .timeline-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .timeline-header-title {
        font-size: 16px;
        font-weight: 700;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .timeline-header-badge {
        font-size: 11px;
        padding: 3px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
        font-weight: 600;
    }

    .timeline-list {
        list-style: none;
        padding-left: 0;
        margin: 0;
        max-height: 420px;
        overflow-y: auto;
    }

    .timeline-item {
        position: relative;
        padding-left: 20px;
        padding-bottom: 14px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-item::before {
        content: "";
        position: absolute;
        left: 6px;
        top: 6px;
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: linear-gradient(135deg, #6366f1, #22c55e);
        box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.25);
    }

    .timeline-item::after {
        content: "";
        position: absolute;
        left: 10px;
        top: 18px;
        width: 2px;
        bottom: -4px;
        background: #e5e7eb;
    }

    .timeline-item:last-child::after {
        display: none;
    }

    .timeline-main {
        font-size: 14px;
        color: #111827;
        font-weight: 500;
    }

    .timeline-meta {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }

    .timeline-tags {
        margin-top: 3px;
        font-size: 12px;
        color: #4b5563;
    }

    .timeline-delete-btn {
        border: none;
        background: transparent;
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        color: #b91c1c;
        border: 1px solid rgba(239, 68, 68, 0.4);
        margin-left: 8px;
    }

    .timeline-delete-btn:hover {
        background: rgba(239, 68, 68, 0.08);
    }

    /* ğŸ› SaÄŸ taraf: aÅŸama kartlarÄ± */
    .stage-column {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .stage-card {
        background: #ffffff;
        border-radius: 14px;
        padding: 14px 16px 10px;
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);
        border: 1px solid #e5e7eb;
    }

    .stage-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .stage-card-title {
        font-size: 14px;
        font-weight: 700;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stage-card-title span.icon {
        font-size: 18px;
    }

    .stage-card-sub {
        font-size: 11px;
        color: #6b7280;
    }

    .stage-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .soft-btn {
        padding: 7px 12px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.18s ease-in-out;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .soft-btn:active {
        transform: scale(0.96);
    }

    .btn-soft-primary {
        background: #e0ecff;
        color: #1d4ed8;
    }

    .btn-soft-primary:hover {
        background: #d1e0ff;
    }

    .btn-soft-warning {
        background: #fff7e6;
        color: #b45309;
    }

    .btn-soft-warning:hover {
        background: #ffedd5;
    }

    .btn-soft-success {
        background: #dcfce7;
        color: #15803d;
    }

    .btn-soft-success:hover {
        background: #bbf7d0;
    }

    .btn-soft-info {
        background: #e0f2fe;
        color: #0369a1;
    }

    .btn-soft-info:hover {
        background: #bae6fd;
    }

    .btn-soft-dark {
        background: #e5e7eb;
        color: #111827;
    }

    .btn-soft-dark:hover {
        background: #d4d4d8;
    }

    .stage-dropdown .dropdown-menu {
        font-size: 13px;
    }

    .stage-dropdown .dropdown-item {
        padding: 4px 10px;
    }
</style>

<hr>
<h3 class="mt-3">ğŸ§µ Ãœretim Paneli</h3>

<div class="production-wrapper">

    {# SOL: Timeline / Ãœretim GeÃ§miÅŸi #}
    <div class="timeline-card">
        <div class="timeline-header">
            <div class="timeline-header-title">
                ğŸ“œ <span>Ãœretim GeÃ§miÅŸi</span>
            </div>
            <div class="timeline-header-badge">
                {{ events|length }} kayÄ±t
            </div>
        </div>

        {% if events %}
            <ul id="gecmis-listesi" class="timeline-list">
                {% for e in events reversed %}
                    {% if e.event_type == "stage" %}
                        <li class="timeline-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="timeline-main">
                                        {% comment %}
                                            Ham stage/valueâ€™larÄ± TÃ¼rkÃ§eye Ã§eviriyoruz
                                        {% endcomment %}
                                        {% if e.stage == 'dikim_durum' and e.value == 'sÄ±raya_alÄ±ndÄ±' %}
                                            Dikime AlÄ±ndÄ±
                                        {% elif e.stage == 'susleme_durum' and e.value == 'sÄ±raya_alÄ±ndÄ±' %}
                                            SÃ¼sleme SÄ±rasÄ±na AlÄ±ndÄ±
                                        {% elif e.stage == 'dikim_durum' and e.value == 'basladi' %}
                                            Dikime BaÅŸlandÄ±
                                        {% elif e.stage == 'dikim_durum' and e.value == 'kismi_bitti' %}
                                            KÄ±smi Dikim YapÄ±ldÄ±
                                        {% elif e.stage == 'dikim_durum' and e.value == 'bitti' %}
                                            Dikim Bitti
                                        {% elif e.stage == 'kesim_durum' and e.value == 'basladi' %}
                                            Kesime BaÅŸlandÄ±
                                        {% elif e.stage == 'kesim_durum' and e.value == 'kismi_bitti' %}
                                            KÄ±smi Kesim YapÄ±ldÄ±
                                        {% elif e.stage == 'kesim_durum' and e.value == 'bitti' %}
                                            Kesim Bitti
                                        {% elif e.stage == 'susleme_durum' and e.value == 'basladi' %}
                                            SÃ¼sleme BaÅŸladÄ±
                                        {% elif e.stage == 'susleme_durum' and e.value == 'kismi_bitti' %}
                                            KÄ±smi SÃ¼sleme YapÄ±ldÄ±
                                        {% elif e.stage == 'susleme_durum' and e.value == 'bitti' %}
                                            SÃ¼sleme Bitti
                                        {% elif e.stage == 'dikim_fason_durumu' and e.value == 'verildi' %}
                                            Dikim Ä°Ã§in Fasona Verildi
                                        {% elif e.stage == 'dikim_fason_durumu' and e.value == 'alindi' %}
                                            Dikim Fasoncusundan AlÄ±ndÄ±
                                        {% elif e.stage == 'susleme_fason_durumu' and e.value == 'verildi' %}
                                            SÃ¼sleme Ä°Ã§in Fasona Verildi
                                        {% elif e.stage == 'susleme_fason_durumu' and e.value == 'alindi' %}
                                            SÃ¼sleme Fasoncusundan AlÄ±ndÄ±
                                        {% elif e.stage == 'sevkiyat_durum' and e.value == 'gonderildi' %}
                                            Sevkiyat GÃ¶nderildi
                                        {% else %}
                                            {{ e.stage|title }} â†’ {{ e.value|title }}
                                        {% endif %}
                                    </div>

                                    <div class="timeline-meta">
                                        {{ e.timestamp|date:"d.m.Y H:i" }} â€” ğŸ‘¤ {{ e.user }}
                                    </div>

                                    <div class="timeline-tags">
                                        {% if e.parca %}ğŸ§© {{ e.parca }}{% endif %}
                                        {% if e.adet %}
    <span style="display:none;">
        {% if e.parca %} â€¢ {% endif %}
        ğŸ”¢ {{ e.adet }} adet
    </span>
{% endif %}
                                        {% if e.aciklama %} {% if e.parca or e.adet %} â€¢ {% endif %}ğŸ’¬ {{ e.aciklama }}{% endif %}
                                        {% if e.ortak_calisanlar %} â€¢ ğŸ‘¥ {{ e.ortak_calisanlar }}{% endif %}
                                        {% if e.fasoncu %} â€¢ ğŸ­ {{ e.fasoncu.ad|upper }}{% endif %}
                                        {% if e.nakisci %} â€¢ ğŸª¡ {{ e.nakisci.ad|upper }}{% endif %}
                                    </div>
                                </div>

                                {% if is_manager %}
                                    <form action="{% url 'delete_order_event' e.id %}"
                                          method="POST"
                                          onsubmit="return confirm('Bu Ã¼retim kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?');">
                                        {% csrf_token %}
                                        <button type="submit" class="timeline-delete-btn">
                                            Sil
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-muted small">
                Bu sipariÅŸ iÃ§in henÃ¼z Ã¼retim kaydÄ± yok.
            </div>
        {% endif %}
    </div>

    {# SAÄ: AÅŸama KartlarÄ± #}
    <div class="stage-column">

        {# âœ‚ï¸ KESÄ°M #}
        <div class="stage-card">
            <div class="stage-card-header">
                <div class="stage-card-title">
                    <span class="icon">âœ‚ï¸</span> <span>Kesim</span>
                </div>
                <div class="stage-card-sub">Kesim sÃ¼reÃ§ adÄ±mlarÄ±</div>
            </div>
            <div class="stage-actions">
                <button class="soft-btn btn-soft-primary"
                        hx-get="{% url 'update_stage' order.id %}"
                        hx-vals='{"stage": "kesim_durum", "value": "basladi"}'
                        hx-target="#uretim-paneli" hx-swap="innerHTML">
                    BaÅŸla
                </button>

                <button class="soft-btn btn-soft-warning"
                        onclick="return kismiIslem(this, 'kesim_durum', 'kismi_bitti');">
                    KÄ±smi Kesim
                </button>

                <button class="soft-btn btn-soft-success"
                        hx-get="{% url 'update_stage' order.id %}"
                        hx-vals='{"stage": "kesim_durum", "value": "bitti"}'
                        hx-target="#uretim-paneli" hx-swap="innerHTML">
                    Kesim Bitti
                </button>
            </div>
        </div>

        {# ğŸ§µ DÄ°KÄ°M #}
        <div class="stage-card">
            <div class="stage-card-header">
                <div class="stage-card-title">
                    <span class="icon">ğŸ§µ</span> <span>Dikim</span>
                </div>
                <div class="stage-card-sub">Dikim sÃ¼reÃ§ adÄ±mlarÄ±</div>
            </div>
            <div class="stage-actions">
                <button class="soft-btn btn-soft-secondary"
                        hx-get="{% url 'update_stage' order.id %}"
                        hx-vals='{"stage": "dikim_durum", "value": "sÄ±raya_alÄ±ndÄ±"}'
                        hx-target="#uretim-paneli" hx-swap="innerHTML">
                    SÄ±raya AlÄ±ndÄ±
                </button>

                <button class="soft-btn btn-soft-primary"
                        hx-get="{% url 'update_stage' order.id %}"
                        hx-vals='{"stage": "dikim_durum", "value": "basladi"}'
                        hx-target="#uretim-paneli" hx-swap="innerHTML">
                    Dikim BaÅŸladÄ±
                </button>

                <button class="soft-btn btn-soft-warning"
                        onclick="return kismiIslem(this, 'dikim_durum', 'kismi_bitti');">
                    KÄ±smi Dikim
                </button>

                <button class="soft-btn btn-soft-success"
                        hx-get="{% url 'update_stage' order.id %}"
                        hx-vals='{"stage": "dikim_durum", "value": "bitti"}'
                        hx-target="#uretim-paneli" hx-swap="innerHTML">
                    Dikim Bitti
                </button>
            </div>
        </div>

        {# ğŸ­ FASON DÄ°KÄ°M #}
        <div class="stage-card">
            <div class="stage-card-header">
                <div class="stage-card-title">
                    <span class="icon">ğŸ­</span> <span>Fason Dikim</span>
                </div>
                <div class="stage-card-sub">Dikim fason sÃ¼reÃ§leri</div>
            </div>
            <div class="stage-actions">

                <div class="dropdown stage-dropdown">
                    <button class="soft-btn btn-soft-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Fason Verildi
                    </button>
                    <ul class="dropdown-menu">
                        {% for f in fasoncular %}
                            <li>
                                <a class="dropdown-item" href="#"
                                   onclick="return fasonIslem('{{ f.id }}', 'dikim_fason_durumu', 'verildi');">
                                    {{ f.ad }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="dropdown stage-dropdown">
                    <button class="soft-btn btn-soft-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Fason AlÄ±ndÄ±
                    </button>
                    <ul class="dropdown-menu">
                        {% for f in fasoncular %}
                            <li>
                                <a class="dropdown-item" href="#"
                                   onclick="return fasonIslem('{{ f.id }}', 'dikim_fason_durumu', 'alindi');">
                                    {{ f.ad }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        {# ğŸª¡ NAKIÅ #}
        <div class="stage-card">
            <div class="stage-card-header">
                <div class="stage-card-title">
                    <span class="icon">ğŸª¡</span> <span>NakÄ±ÅŸ</span>
                </div>
                <div class="stage-card-sub">NakÄ±ÅŸ fason sÃ¼reÃ§leri</div>
            </div>
            <div class="stage-actions">

                <div class="dropdown stage-dropdown">
                    <button class="soft-btn btn-soft-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        NakÄ±ÅŸ Verildi
                    </button>
                    <ul class="dropdown-menu">
                        {% for n in nakisciler %}
                            <li>
                                <a class="dropdown-item" href="#"
                                   onclick="return fasonIslem('{{ n.id }}', 'nakis_durumu', 'verildi');">
                                    {{ n.ad }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="dropdown stage-dropdown">
                    <button class="soft-btn btn-soft-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        NakÄ±ÅŸ AlÄ±ndÄ±
                    </button>
                    <ul class="dropdown-menu">
                        {% for n in nakisciler %}
                            <li>
                                <a class="dropdown-item" href="#"
                                   onclick="return fasonIslem('{{ n.id }}', 'nakis_durumu', 'alindi');">
                                    {{ n.ad }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

            </div>
        </div>

        {# âœ¨ SÃœSLEME #}
        <div class="stage-card">
            <div class="stage-card-header">
                <div class="stage-card-title">
                    <span class="icon">âœ¨</span> <span>SÃ¼sleme</span>
                </div>
                <div class="stage-card-sub">SÃ¼sleme sÃ¼reÃ§ adÄ±mlarÄ±</div>
            </div>
            <div class="stage-actions">
                <button class="soft-btn btn-soft-secondary"
                        hx-get="{% url 'update_stage' order.id %}"
                        hx-vals='{"stage": "susleme_durum", "value": "sÄ±raya_alÄ±ndÄ±"}'
                        hx-target="#uretim-paneli" hx-swap="innerHTML">
                    SÄ±raya AlÄ±ndÄ±
                </button>

                <button class="soft-btn btn-soft-primary"
                        hx-get="{% url 'update_stage' order.id %}"
                        hx-vals='{"stage": "susleme_durum", "value": "basladi"}'
                        hx-target="#uretim-paneli" hx-swap="innerHTML">
                    SÃ¼sleme BaÅŸladÄ±
                </button>

                <button class="soft-btn btn-soft-warning"
                        onclick="return kismiIslem(this, 'susleme_durum', 'kismi_bitti');">
                    KÄ±smi SÃ¼sleme
                </button>

                <button class="soft-btn btn-soft-success"
                        hx-get="{% url 'update_stage' order.id %}"
                        hx-vals='{"stage": "susleme_durum", "value": "bitti"}'
                        hx-target="#uretim-paneli" hx-swap="innerHTML">
                    SÃ¼sleme Bitti
                </button>
            </div>
        </div>

        {# ğŸ“¦ HAZIR & ğŸšš SEVKÄ°YAT #}
        <div class="stage-card">
            <div class="stage-card-header">
                <div class="stage-card-title">
                    <span class="icon">ğŸ“¦</span> <span>HazÄ±r & Sevkiyat</span>
                </div>
                <div class="stage-card-sub">Depoya giriÅŸ & sevkiyat</div>
            </div>
            <div class="stage-actions">
                <button type="button"
                        class="soft-btn btn-soft-success"
                        data-bs-toggle="modal"
                        data-bs-target="#stokModal">
                    Depoya Girdi
                </button>

                <button class="soft-btn btn-soft-dark"
                        hx-get="{% url 'update_stage' order.id %}"
                        hx-vals='{"stage": "sevkiyat_durum", "value": "gonderildi"}'
                        hx-target="#uretim-paneli" hx-swap="innerHTML">
                    ğŸšš GÃ¶nderildi
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function kismiIslem(button, stage, value) {
    const text = prompt("KÄ±smi iÅŸlemi belirtiniz (Ã¶r: Kol, Etek, Yaka)");
    if (!text) return false;

    htmx.ajax('GET', "{% url 'update_stage' order.id %}", {
        target: '#uretim-paneli',
        swap: 'innerHTML',
        values: {
            stage: stage,
            value: value,
            aciklama: text
        }
    });
    return false;
}

function fasonIslem(fasoncuId, stage, value) {
    if (!fasoncuId) return false;

    htmx.ajax('GET', "{% url 'update_stage' order.id %}", {
        target: '#uretim-paneli',
        swap: 'innerHTML',
        values: {
            stage: stage,
            value: value,
            fasoncu: fasoncuId
        }
    });
    return false;
}

document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.target.id === 'uretim-paneli') {
        const list = document.getElementById('gecmis-listesi');
        if (list && list.lastElementChild) {
            list.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
    }
});
</script>

{# Depoya AktarÄ±m Modal'Ä± aynen koruyoruz #}
<div class="modal fade" id="stokModal" tabindex="-1" aria-labelledby="stokModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{% url 'stok_ekle' order.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="stokModalLabel">Depoya ÃœrÃ¼n AktarÄ±mÄ±</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Depo SeÃ§</label>
            <select name="depo" class="form-select" required>
              <option value="">-- SeÃ§iniz --</option>
              <option value="KORIDOR">Koridor</option>
              <option value="SHOWROOM">Showroom</option>
              <option value="SHOWROOM_MUTF">Showroom Mutfak</option>
              <option value="DANTEL_YANI">Dantel OdasÄ± YanÄ±</option>
              <option value="ELISI">EliÅŸi Deposu</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Adet</label>
            <input type="number" name="adet" class="form-control"
                   value="{{ order.adet|default_if_none:'' }}" min="1" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
          <button type="submit" class="btn btn-success">Kaydet</button>
        </div>
      </form>
    </div>
  </div>
</div>
